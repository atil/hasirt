<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>hello phaser!</title>
        <link rel="stylesheet" href="style.css">
        <script src="phaser-2.6.2/build/phaser.min.js"></script>
        <script src="wave.js"></script>
        <script src="endgame.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        var game = new Phaser.Game(window.screen.availWidth, window.screen.availHeight,
             Phaser.AUTO, '', 
            { preload: preload, create: create, update: update });

		var cursors;
        var player1;
        var player2;

        var wave;
        var endgame;
        var isRunning = true;

        var direction = {
            left : 0, right : 1
        }

        var currentDirection = direction.right;

        function preload () {
            game.rect = {
                x: game.world.centerX,
                y: game.world.centerY,
                width: game.width,
                height: game.height,
            }

            game.load.image('logo', 'assets/phaser.png');
            game.load.image('yellow', 'assets/yellow.png');
            game.load.image('red', 'assets/red.png');
            game.load.image('blue', 'assets/blue.png');

            preloadWave(game);
            preloadEndgame(game);

            cursors = game.input.keyboard.createCursorKeys();
        }

        function create () {
            var logo = game.add.sprite(game.rect.x, game.rect.y, 'logo');
            logo.anchor.setTo(0.5, 0.5);

            player1 = game.add.sprite(0, 0, 'yellow');
            player1.position.setTo(player1.width / 2, game.rect.y);
            player1.anchor.setTo(0.5, 0.5);
            player1.direction = direction.left;

            player2 = game.add.sprite(0, 0, 'red');
            player2.position.setTo(game.rect.width - player2.width / 2, game.rect.y);
            player2.anchor.setTo(0.5, 0.5);
            player2.direction = direction.right;

            wave = initWave(game);
            endgame = initEndgame(game);

            game.input.keyboard.addKey(Phaser.Keyboard.W).onDown.add(function() {
                onKeyPress(direction.left, 'up');
            });
            game.input.keyboard.addKey(Phaser.Keyboard.A).onDown.add(function() {
                onKeyPress(direction.left, 'left');
            });
            game.input.keyboard.addKey(Phaser.Keyboard.S).onDown.add(function() {
                onKeyPress(direction.left, 'down');
            });
            game.input.keyboard.addKey(Phaser.Keyboard.D).onDown.add(function() {
                onKeyPress(direction.left, 'right');
            });

            game.input.keyboard.addKey(Phaser.Keyboard.UP).onDown.add(function() {
                onKeyPress(direction.right, 'up');
            });
            game.input.keyboard.addKey(Phaser.Keyboard.LEFT).onDown.add(function() {
                onKeyPress(direction.right, 'left');
            });
            game.input.keyboard.addKey(Phaser.Keyboard.DOWN).onDown.add(function() {
                onKeyPress(direction.right, 'down');
            });
            game.input.keyboard.addKey(Phaser.Keyboard.RIGHT).onDown.add(function() {
                onKeyPress(direction.right, 'right');
            });

            game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR).onDown.add(function() {
                if (!isRunning) {
                    isRunning = true;
                    resetWave(wave);
                    clearEndgame(endgame);
                }
            });
        }

        function onKeyPress(keyDir, keyStr) {
            if (keyDir == currentDirection) {
                var result = processKeyPress(wave, keyStr);
                if (result == wave.result.complete) {
                    currentDirection = 1 - currentDirection;
                }
            } else {
                // bonus seq?
            }

        }

		function update() {
            var dt = game.time.elapsed / 1000;
            if (isRunning) {
                if (wave.x < 0 || wave.x > game.rect.width) {
                    showEndgame(endgame, currentDirection);
                    isRunning = false;
                } else {
                    updateWave(wave, currentDirection, dt);
                }
            } else {
                updateEndgame(endgame);
            }

		}

    };

    </script>

    </body>
</html>